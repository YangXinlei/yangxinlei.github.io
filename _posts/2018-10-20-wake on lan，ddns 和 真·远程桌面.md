---
layout: post
title:  "Wake on Lan，DDNS 和 真·远程桌面"
date:   2018-10-20 23:51:22 +0800
categories: develop
---

最近折腾出来一个很好玩的事情，分享一下
现在，我可以自由的*开关*我的电脑，随时在不同设备上访问和使用，实在方便。

~按照先例~，先列大纲，慢慢填

## 涉及内容

* BIOS设置和网卡驱动
* DDNS
* 服务器和Node.js
* 微软远程桌面

（太长不看：简要步骤 1.BIOS允许网卡启动；2.网卡驱动设置允许wake on lan; 3.设法监听路由器动态IP；4.使用休眠替代关机；5.发送魔包唤醒PC 6.远程连接使用）

### 打开开关

BIOS的UI终于从“DOS”进化到了“Vista”,我现在使用的主板是一款微星的B250主板，当初第一次点亮的时候是颇为吃惊的。关于BIOS的设置其实只有一处，就是在主板的启动选项里设置允许网卡启动。但是有几点需要说明一下：
1. 系统挂起有S1~S5五种，其中S3（挂起到内存），S4（挂起到硬盘），和S5（关闭所有设备）分别对应windows的睡眠、休眠和关机。更高的状态拥有更低的功耗，而唤醒的难度则更大，事实上，我现在只做到了在休眠模式下唤醒PC，不过这对我来说是足够好的。
2. 在BIOS里，有一项网卡相关的设置，其中会有一个 wake on Lan 的选项，不过，对于我的Intel i219-v 此项没提供除[N/A]以外的选项。
3. 显然，远程唤醒意味着网卡需要始终处于供电状态并接收数据包，也就意味着，网卡的指示灯和路由器对应的LAN口的指示灯是常亮的。
4. 除了设置BIOS选项以为，更为重要的，是在系统的网卡驱动选项中开启远程唤醒功能，但是想要此功能完美生效，一定要确保安装了最新的显卡驱动。需要注意的是，windows自动安装的网卡驱动可能不是最新的，使用某些驱动管理软件更新的网卡驱动也可能不是最新的。直接去Intel官网下载最新的驱动，可以帮你节省不少力气。
 ---todo
5.另外，注意要关闭windows的快速启动。
6.以及，避免网卡自动唤醒windows。
---todo


### 唤醒PC

一种称为“魔包”的特殊数据包被发送到网卡，作为唤醒PC的指令。我们不需要关心魔包的具体内容，只需要配置好正确的mac地址、ip和端口号，魔包可以由代码自动生成。

#### DDNS

我们网卡的mac地址是固定的，端口号是由我们指定的。但是对于国内常见的家庭宽带用户，我们的IP通常不是固定的，而是由ISP动态分配的，如果不能实时的获知IP地址，远程连接也就没有意义了。
目前有一些提供免费动态域名解析服务的网站，看了一下使用这些服务的操作流程，我猜测其流程其实很简单。服务商为你提供一个专属域名，此域名为其拥有域名的一个子域名，由于是子域名，因此DNS解析服务由该服务商提供，你的路由器实时把新的IP地址发送给服务商，服务商更新其DNS服务器，从而保证了你的专属域名总是能够成功的定位到你的PC。固定的域名对动态的IP做了封装。 对于某些声称免费的服务，我总会有一些隐虑。
于是

#### 如果你刚好有一台自己的服务器 

是的，如果你刚好有一台自己的服务器，其实完全不需要这些第三方服务商也能保持IP的更新。
起初，我很好奇路由器是如何汇报动态IP的，于是便在DDNS相关配置里写上了我的一个私人服务器，通过服务器上安装的Nginx可以看到，每当IP变化时，我的路由器便会以1分钟的间隔向我发送5次连续的GET请求，请求内容比我想象的还简单：
todo

此时，一切水到渠成。我只需要写一个服务，接收IP更新的请求，保存我自己最新的IP，甚至在IP变化时发给自己一封通知邮件。（[Node代码](todo)）

一切准备就绪

#### 真远程唤醒

*我强调“真”是因为一些资料里所谓的远程唤醒其实是局域网唤醒，实际意义实在有限。*

远程唤醒的工具各个平台都有很多，[可以尝试下这个在线唤醒工具](https://www.depicus.com/wake-on-lan/woli)

不过IP懒得记，邮件也懒得翻，还是全交给服务器来做吧：[代码](todo)

#### 可是唤醒太频繁了

不知道什么原因，网卡开启了wol以后，电脑总是自动从休眠状态唤醒。通过命令`powercfg -lastwake`查看最近一次唤醒原因，发现的确是被网卡唤醒的。再次回到网卡的属性设置。尝试取消勾选“唤醒模式匹配”，之后就没再遇到忽然自动启动的问题了，看来除了魔包数据还存在其他的唤醒模式。
[PC无故启动troubleshoot链接](https://www.howtogeek.com/122954/how-to-prevent-your-computer-from-waking-up-accidentally/)

## 剩下的就交给远程桌面

## 远程桌面

微软远程桌面（RD Client）在主流平台都有提供，如果你是mac系统，目前App Store下架了， 国内ID可以考虑下载beta版。配置很简单，上图
todo


### 结果很酷

现在，我随时随地都可以在我的任何设备上访问我家里的电脑。无论是我的 MacBook, iPad 还是我4寸的iPhone SE。前两天在公司刷IT之家，看到尘埃4 Steam上搞特价，我连上家里PC，打开steam，下单，安装，甚至还*小窗*玩了会儿。

小窗的原因不是因为在公司，而是带宽不够。即便尽可能把窗口开到最小，其帧率大概也没超过10吧。想自己搭“云游戏”的还需要再等等。
